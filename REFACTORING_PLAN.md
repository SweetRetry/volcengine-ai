# 系统重构计划

## 🔍 发现的问题

### 1. **代码重复和冗余**
- ❌ AI Handler中三种任务类型有重复的默认提供商/模型设置逻辑
- ❌ 请求结构体定义重复，字段相似但分别定义
- ❌ 任务创建流程代码重复

### 2. **过度设计**
- ❌ 数据库接口定义了过多未使用的方法（YAGNI问题）
- ❌ Task、AIRequest等模型定义但实际只使用ImageTask
- ❌ 复杂的数据库抽象层，但只有MongoDB一种实现

### 3. **架构不一致**
- ❌ 有些地方使用了服务注册器模式，有些地方还是直接依赖
- ❌ 路由命名不一致（/image/task vs /text/task）
- ❌ 响应格式在不同接口间略有差异

### 4. **未完成的功能**
- ❌ 大量TODO注释和未实现的功能
- ❌ OpenAI Provider只是示例实现
- ❌ 文本和视频任务只返回"未实现"

### 5. **配置和环境**
- ❌ 硬编码的默认API Key（安全问题）
- ❌ 配置结构可以更简洁
- ❌ 缺少配置验证

## ✅ 改进方案

### 1. **代码重构**

#### A. 使用工厂模式统一任务创建
```go
// 新增：internal/handler/ai_task_factory.go
type AITaskFactory struct {
    // 统一处理所有类型任务的创建逻辑
}

// 新增：internal/handler/ai_handler_refactored.go  
type AIHandlerRefactored struct {
    // 使用工厂模式，大幅简化代码
}
```

#### B. 统一请求结构体
```go
// 通用AI任务请求结构，包含所有任务类型的字段
type AITaskRequest struct {
    // 公共字段 + 特定字段（使用omitempty）
}
```

### 2. **简化数据库层**

#### A. 精简接口
```go
// 新增：internal/database/interface_simplified.go
type DatabaseSimplified interface {
    // 只保留实际使用的方法
}
```

#### B. 移除未使用的模型
- 删除 `Task` 和 `AIRequest` 模型
- 只保留 `User` 和 `ImageTask`

### 3. **统一架构模式**

#### A. 全面使用服务注册器
- 所有AI服务都通过注册器管理
- 移除直接的服务依赖

#### B. 统一路由设计
```go
// 建议的新路由结构
POST /api/v1/ai/tasks        // 创建任务（通过type参数区分）
GET  /api/v1/ai/tasks/:id    // 查询任务结果
GET  /api/v1/ai/tasks        // 获取用户任务列表
DELETE /api/v1/ai/tasks/:id  // 删除任务
```

### 4. **清理未完成功能**

#### A. 移除或完善TODO
- 要么实现功能，要么移除占位代码
- 明确标记哪些是示例代码

#### B. 简化Provider实现
- OpenAI Provider要么完整实现，要么标记为示例

### 5. **配置优化**

#### A. 安全性改进
```go
type Config struct {
    // 移除硬编码的API Key
    // 添加配置验证
}
```

#### B. 环境变量验证
```go
func (c *Config) Validate() error {
    // 验证必需的配置项
}
```

## 🚀 实施步骤

### 阶段1：核心重构（高优先级）
1. ✅ 创建 `AITaskFactory` 统一任务创建逻辑
2. ✅ 创建 `AIHandlerRefactored` 简化Handler
3. ✅ 创建 `DatabaseSimplified` 精简数据库接口
4. ✅ 更新路由使用重构后的Handler
5. ✅ 移除原有的重复代码
6. ✅ 重构MongoDB实现，移除未使用的方法
7. ✅ 重构ImageTaskService使用新接口
8. ✅ 移除硬编码API Key，添加配置验证

### 阶段2：架构统一（中优先级）
1. 统一所有服务使用注册器模式
2. 标准化API响应格式
3. 统一错误处理机制
4. 优化配置管理

### 阶段3：功能完善（低优先级）
1. 完善文本和视频任务实现
2. 完善OpenAI Provider
3. 添加更多AI服务提供商
4. 完善测试覆盖

### 阶段4：清理优化（持续）
1. 移除未使用的文件和代码
2. 优化性能
3. 完善文档
4. 代码质量提升

## 📊 预期收益

### 代码质量
- **减少50%+的重复代码**
- **提高代码可读性和维护性**
- **统一的架构模式**

### 开发效率
- **新增AI服务提供商更简单**
- **新增任务类型更容易**
- **调试和排错更方便**

### 系统性能
- **减少不必要的抽象层开销**
- **简化的数据库操作**
- **更清晰的依赖关系**

## 🎯 成功指标

1. **代码行数减少20%+**
2. **Handler方法数量减少50%+**
3. **新增功能开发时间减少30%+**
4. **单元测试覆盖率提升到80%+**
5. **API响应时间优化10%+**

---

**注意**：这是一个渐进式重构计划，可以分阶段实施，不会影响现有功能的正常运行。 