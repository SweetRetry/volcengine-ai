---
description: 
globs: 
alwaysApply: true
---
# Go ç¼–ç è§„èŒƒä¸æœ€ä½³å®è·µ

## ğŸ“ ä»£ç é£æ ¼è§„èŒƒ

### å‘½åçº¦å®š
- **åŒ…å**: ä½¿ç”¨å°å†™å­—æ¯ï¼Œç®€çŸ­ä¸”æœ‰æ„ä¹‰ (å¦‚ `service`, `handler`, `util`)
- **æ¥å£å**: ä½¿ç”¨ `er` åç¼€ (å¦‚ `TaskDispatcher`, `ServiceProvider`)
- **ç»“æ„ä½“**: ä½¿ç”¨ PascalCase (å¦‚ `TaskService`, `AIProvider`)
- **å‡½æ•°/æ–¹æ³•**: ä½¿ç”¨ PascalCase å¯¼å‡ºï¼ŒcamelCase ç§æœ‰ (å¦‚ `CreateTask`, `validateInput`)
- **å¸¸é‡**: ä½¿ç”¨ UPPER_SNAKE_CASE (å¦‚ `MAX_RETRY_COUNT`, `DEFAULT_TIMEOUT`)
- **å˜é‡**: ä½¿ç”¨ camelCase (å¦‚ `taskID`, `userRequest`)

### æ–‡ä»¶ç»„ç»‡
- **ä¸€ä¸ªæ–‡ä»¶ä¸€ä¸ªä¸»è¦ç±»å‹**: æ¯ä¸ª `.go` æ–‡ä»¶åº”è¯¥ä¸“æ³¨äºä¸€ä¸ªä¸»è¦çš„ç»“æ„ä½“æˆ–æ¥å£
- **æµ‹è¯•æ–‡ä»¶**: ä½¿ç”¨ `_test.go` åç¼€ï¼Œä¸è¢«æµ‹è¯•æ–‡ä»¶æ”¾åœ¨åŒä¸€åŒ…ä¸­
- **æ¥å£å®šä¹‰**: ä¼˜å…ˆåœ¨ä½¿ç”¨æ–¹åŒ…ä¸­å®šä¹‰æ¥å£ï¼Œè€Œä¸æ˜¯å®ç°æ–¹

## ğŸ—ï¸ æ¶æ„æ¨¡å¼

### åˆ†å±‚æ¶æ„åŸåˆ™
```go
// âœ… æ­£ç¡®çš„ä¾èµ–æ–¹å‘
Handler -> Service -> Repository -> Database
Provider -> Service (é€šè¿‡æ¥å£)
Core -> Provider (é€šè¿‡æ³¨å†Œæœºåˆ¶)
```

### æ¥å£è®¾è®¡
```go
// âœ… æ¨èï¼šå°è€Œä¸“æ³¨çš„æ¥å£
type TaskCreator interface {
    CreateTask(ctx context.Context, req CreateTaskRequest) (*Task, error)
}

type TaskQuerier interface {
    GetTask(ctx context.Context, id string) (*Task, error)
    ListTasks(ctx context.Context, filter TaskFilter) ([]*Task, error)
}

// âŒ é¿å…ï¼šè¿‡å¤§çš„æ¥å£
type TaskManager interface {
    CreateTask(ctx context.Context, req CreateTaskRequest) (*Task, error)
    GetTask(ctx context.Context, id string) (*Task, error)
    UpdateTask(ctx context.Context, id string, updates TaskUpdates) error
    DeleteTask(ctx context.Context, id string) error
    ListTasks(ctx context.Context, filter TaskFilter) ([]*Task, error)
    ProcessTask(ctx context.Context, id string) error
}
```

## ğŸ”§ é”™è¯¯å¤„ç†

### é”™è¯¯åŒ…è£…å’Œä¼ æ’­
```go
// âœ… ä½¿ç”¨ fmt.Errorf åŒ…è£…é”™è¯¯
func (s *TaskService) CreateTask(ctx context.Context, req CreateTaskRequest) (*Task, error) {
    if err := s.validateRequest(req); err != nil {
        return nil, fmt.Errorf("invalid request: %w", err)
    }
    
    task, err := s.repo.Create(ctx, req)
    if err != nil {
        return nil, fmt.Errorf("failed to create task: %w", err)
    }
    
    return task, nil
}
```

### ç»Ÿä¸€é”™è¯¯å“åº”
```go
// åœ¨ api/handlers ä¸­ä½¿ç”¨ç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼
type ErrorResponse struct {
    Code    int    `json:"code"`
    Message string `json:"message"`
    Details string `json:"details,omitempty"`
}
```

## ğŸ“Š æ—¥å¿—è®°å½•

### ç»“æ„åŒ–æ—¥å¿—
```go
// âœ… ä½¿ç”¨ç»“æ„åŒ–å­—æ®µ
logger.WithFields(logrus.Fields{
    "task_id": taskID,
    "user_id": userID,
    "action":  "create_task",
}).Info("ä»»åŠ¡åˆ›å»ºæˆåŠŸ")

// âŒ é¿å…å­—ç¬¦ä¸²æ‹¼æ¥
logger.Info("Task " + taskID + " created for user " + userID)
```

### æ—¥å¿—çº§åˆ«ä½¿ç”¨
- **Error**: ç³»ç»Ÿé”™è¯¯ï¼Œéœ€è¦ç«‹å³å…³æ³¨
- **Warn**: æ½œåœ¨é—®é¢˜ï¼Œä½†ä¸å½±å“æ­£å¸¸è¿è¡Œ
- **Info**: é‡è¦çš„ä¸šåŠ¡äº‹ä»¶
- **Debug**: è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯

## ğŸ§ª æµ‹è¯•è§„èŒƒ

### æµ‹è¯•æ–‡ä»¶ç»“æ„
```go
func TestTaskService_CreateTask(t *testing.T) {
    tests := []struct {
        name    string
        req     CreateTaskRequest
        want    *Task
        wantErr bool
    }{
        {
            name: "valid request",
            req:  CreateTaskRequest{/* ... */},
            want: &Task{/* ... */},
            wantErr: false,
        },
        {
            name: "invalid request",
            req:  CreateTaskRequest{/* ... */},
            want: nil,
            wantErr: true,
        },
    }
    
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            // æµ‹è¯•é€»è¾‘
        })
    }
}
```

### Mock å’Œä¾èµ–æ³¨å…¥
```go
// ä½¿ç”¨æ¥å£è¿›è¡Œä¾èµ–æ³¨å…¥ï¼Œä¾¿äºæµ‹è¯•
type TaskService struct {
    repo   TaskRepository
    logger *logrus.Logger
}

func NewTaskService(repo TaskRepository, logger *logrus.Logger) *TaskService {
    return &TaskService{
        repo:   repo,
        logger: logger,
    }
}
```

## ğŸ”’ å®‰å…¨æœ€ä½³å®è·µ

### è¾“å…¥éªŒè¯
```go
// ä½¿ç”¨ validator æ ‡ç­¾è¿›è¡Œè¾“å…¥éªŒè¯
type CreateTaskRequest struct {
    Title       string `json:"title" validate:"required,min=1,max=100"`
    Description string `json:"description" validate:"max=500"`
    ModelName   string `json:"model_name" validate:"required,oneof=doubao jimeng"`
}
```

### æ•æ„Ÿä¿¡æ¯å¤„ç†
```go
// âœ… ä¸åœ¨æ—¥å¿—ä¸­è®°å½•æ•æ„Ÿä¿¡æ¯
logger.WithFields(logrus.Fields{
    "user_id": userID,
    "action":  "api_call",
}).Info("APIè°ƒç”¨æˆåŠŸ")

// âŒ é¿å…è®°å½•APIå¯†é’¥ç­‰æ•æ„Ÿä¿¡æ¯
logger.Info("API Key: " + apiKey) // å±é™©ï¼
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### Context ä½¿ç”¨
```go
// âœ… æ­£ç¡®ä¼ é€’å’Œä½¿ç”¨ context
func (s *TaskService) ProcessTask(ctx context.Context, taskID string) error {
    // è®¾ç½®è¶…æ—¶
    ctx, cancel := context.WithTimeout(ctx, 30*time.Second)
    defer cancel()
    
    // ä¼ é€’ç»™ä¸‹æ¸¸è°ƒç”¨
    return s.aiProvider.GenerateImage(ctx, request)
}
```

### èµ„æºç®¡ç†
```go
// âœ… åŠæ—¶å…³é—­èµ„æº
func (r *TaskRepository) GetTask(ctx context.Context, id string) (*Task, error) {
    cursor, err := r.collection.Find(ctx, bson.M{"_id": id})
    if err != nil {
        return nil, err
    }
    defer cursor.Close(ctx) // é‡è¦ï¼šåŠæ—¶å…³é—­æ¸¸æ ‡
    
    // å¤„ç†ç»“æœ...
}
```

## ğŸ“¦ ä¾èµ–ç®¡ç†

### go.mod ç»´æŠ¤
- å®šæœŸè¿è¡Œ `go mod tidy` æ¸…ç†æœªä½¿ç”¨çš„ä¾èµ–
- ä½¿ç”¨å…·ä½“ç‰ˆæœ¬è€Œä¸æ˜¯ `latest`
- é‡è¦ä¾èµ–å›ºå®šç‰ˆæœ¬ï¼Œé¿å…æ„å¤–å‡çº§

### å¯¼å…¥é¡ºåº
```go
import (
    // æ ‡å‡†åº“
    "context"
    "fmt"
    "time"
    
    // ç¬¬ä¸‰æ–¹åº“
    "github.com/gin-gonic/gin"
    "github.com/sirupsen/logrus"
    
    // é¡¹ç›®å†…éƒ¨åŒ…
    "volcengine-go-server/internal/models"
    "volcengine-go-server/internal/service"
)
```
