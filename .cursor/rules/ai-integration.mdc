---
description: 
globs: 
alwaysApply: false
---
# AI æœåŠ¡é›†æˆæŒ‡å—

## ğŸ”¥ ç«å±±æ–¹èˆŸ AI æœåŠ¡é›†æˆ

### æ”¯æŒçš„AIæ¨¡å‹
- **è±†åŒ…å›¾åƒç”Ÿæˆ**: `doubao-seedream-3-0-t2i-250415` - é«˜è´¨é‡å›¾åƒç”Ÿæˆ
- **å³æ¢¦AIå›¾åƒç”Ÿæˆ**: `jimeng_high_aes_general_v21_L` - ä¸“ä¸šçº§è‰ºæœ¯åˆ›ä½œ
- **å³æ¢¦AIè§†é¢‘ç”Ÿæˆ**: `jimeng_vgfm_t2v_l20` - æ–‡æœ¬åˆ°è§†é¢‘ç”Ÿæˆ

### Provider-Service æ¶æ„æ¨¡å¼

#### Providerå±‚èŒè´£
```go
// Providerè´Ÿè´£ä»»åŠ¡åˆ†å‘å’Œè·¯ç”±
type VolcengineProvider struct {
    imageService ImageGenerationService
    videoService VideoGenerationService
    logger       *logrus.Logger
}

func (p *VolcengineProvider) DispatchTask(ctx context.Context, task *Task) error {
    switch task.ModelName {
    case "doubao-seedream-3-0-t2i-250415":
        return p.imageService.GenerateDoubaoImage(ctx, task)
    case "jimeng_high_aes_general_v21_L":
        return p.imageService.GenerateJimengImage(ctx, task)
    case "jimeng_vgfm_t2v_l20":
        return p.videoService.GenerateJimengVideo(ctx, task)
    default:
        return fmt.Errorf("unsupported model: %s", task.ModelName)
    }
}
```

#### Serviceå±‚èŒè´£
```go
// Serviceè´Ÿè´£å…·ä½“çš„AI APIè°ƒç”¨
type VolcengineImageService struct {
    arkClient    *ark.Client
    visualClient *visual.Client
    logger       *logrus.Logger
}

func (s *VolcengineImageService) GenerateDoubaoImage(ctx context.Context, task *Task) error {
    // å…·ä½“çš„è±†åŒ…APIè°ƒç”¨é€»è¾‘
    request := &ark.ImageGenerationRequest{
        Model:  task.ModelName,
        Prompt: task.Prompt,
        // å…¶ä»–å‚æ•°...
    }
    
    response, err := s.arkClient.GenerateImage(ctx, request)
    if err != nil {
        return fmt.Errorf("è±†åŒ…å›¾åƒç”Ÿæˆå¤±è´¥: %w", err)
    }
    
    // å¤„ç†å“åº”...
    return nil
}
```

## ğŸ¯ ä»»åŠ¡é˜Ÿåˆ—é›†æˆ

### å¼‚æ­¥ä»»åŠ¡å¤„ç†
```go
// ä½¿ç”¨Asynqè¿›è¡Œå¼‚æ­¥ä»»åŠ¡å¤„ç†
type AITaskProcessor struct {
    registry *ServiceRegistry
    logger   *logrus.Logger
}

func (p *AITaskProcessor) ProcessTask(ctx context.Context, t *asynq.Task) error {
    var task Task
    if err := json.Unmarshal(t.Payload(), &task); err != nil {
        return fmt.Errorf("ä»»åŠ¡ååºåˆ—åŒ–å¤±è´¥: %w", err)
    }
    
    // æ ¹æ®ä»»åŠ¡ç±»å‹è·å–å¯¹åº”çš„Provider
    provider := p.registry.GetProvider(task.ProviderType)
    if provider == nil {
        return fmt.Errorf("æœªæ‰¾åˆ°Provider: %s", task.ProviderType)
    }
    
    // åˆ†å‘ä»»åŠ¡
    return provider.DispatchTask(ctx, &task)
}
```

### ä»»åŠ¡ä¼˜å…ˆçº§é…ç½®
```go
// ä»»åŠ¡ä¼˜å…ˆçº§å®šä¹‰
const (
    PriorityCritical = "critical" // ç´§æ€¥ä»»åŠ¡
    PriorityDefault  = "default"  // æ™®é€šä»»åŠ¡
    PriorityLow      = "low"      // ä½ä¼˜å…ˆçº§ä»»åŠ¡
)

// æ ¹æ®ä»»åŠ¡ç±»å‹è®¾ç½®ä¼˜å…ˆçº§
func GetTaskPriority(taskType string) string {
    switch taskType {
    case "video_generation":
        return PriorityCritical // è§†é¢‘ç”Ÿæˆä¼˜å…ˆçº§é«˜
    case "image_generation":
        return PriorityDefault
    default:
        return PriorityLow
    }
}
```

## ğŸ”§ é…ç½®ç®¡ç†

### ç¯å¢ƒå˜é‡é…ç½®
```go
type AIConfig struct {
    // ç«å±±æ–¹èˆŸé…ç½®
    ARKAPIKey    string `env:"ARK_API_KEY" validate:"required"`
    ARKBaseURL   string `env:"ARK_BASE_URL" default:"https://ark.cn-beijing.volces.com/api/v3"`
    
    // ç«å±±å¼•æ“Visualé…ç½® (å³æ¢¦AI)
    VolcAccessKey string `env:"VOLCENGINE_ACCESS_KEY"`
    VolcSecretKey string `env:"VOLCENGINE_SECRET_KEY"`
    VolcRegion    string `env:"VOLCENGINE_REGION" default:"cn-north-1"`
    
    // é€šç”¨é…ç½®
    AITimeout     time.Duration `env:"AI_TIMEOUT" default:"30s"`
    MaxRetries    int           `env:"AI_MAX_RETRIES" default:"3"`
    RetryInterval time.Duration `env:"AI_RETRY_INTERVAL" default:"5s"`
}
```

### æ¨¡å‹å‚æ•°é…ç½®
```go
// è±†åŒ…å›¾åƒç”Ÿæˆå‚æ•°
type DoubaoImageParams struct {
    Width       int     `json:"width" validate:"min=512,max=2048"`
    Height      int     `json:"height" validate:"min=512,max=2048"`
    Steps       int     `json:"steps" validate:"min=1,max=50" default:"20"`
    Scale       float64 `json:"scale" validate:"min=1,max=20" default:"7.5"`
    Seed        int64   `json:"seed,omitempty"`
    ReturnType  string  `json:"return_type" validate:"oneof=url base64" default:"url"`
}

// å³æ¢¦AIå›¾åƒç”Ÿæˆå‚æ•° (å®˜æ–¹æ¨èå°ºå¯¸)
type JimengImageParams struct {
    Width      int    `json:"width" validate:"oneof=512 768 1024" default:"1024"`
    Height     int    `json:"height" validate:"oneof=512 768 1024" default:"1024"`
    ReturnType string `json:"return_type" validate:"oneof=url base64" default:"url"`
}
```

## ğŸš¨ é”™è¯¯å¤„ç†å’Œé‡è¯•

### AIæœåŠ¡é”™è¯¯åˆ†ç±»
```go
type AIError struct {
    Code    string `json:"code"`
    Message string `json:"message"`
    Type    string `json:"type"` // "rate_limit", "quota_exceeded", "model_error", "network_error"
}

func (e *AIError) Error() string {
    return fmt.Sprintf("AIæœåŠ¡é”™è¯¯ [%s]: %s", e.Code, e.Message)
}

// åˆ¤æ–­æ˜¯å¦éœ€è¦é‡è¯•
func (e *AIError) IsRetryable() bool {
    switch e.Type {
    case "rate_limit", "network_error":
        return true
    case "quota_exceeded", "model_error":
        return false
    default:
        return false
    }
}
```

### é‡è¯•ç­–ç•¥
```go
func (s *VolcengineService) GenerateImageWithRetry(ctx context.Context, task *Task) error {
    var lastErr error
    
    for attempt := 0; attempt < s.config.MaxRetries; attempt++ {
        if attempt > 0 {
            // æŒ‡æ•°é€€é¿
            backoff := time.Duration(attempt) * s.config.RetryInterval
            select {
            case <-ctx.Done():
                return ctx.Err()
            case <-time.After(backoff):
            }
        }
        
        err := s.generateImage(ctx, task)
        if err == nil {
            return nil
        }
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºå¯é‡è¯•é”™è¯¯
        if aiErr, ok := err.(*AIError); ok && !aiErr.IsRetryable() {
            return err
        }
        
        lastErr = err
        s.logger.WithFields(logrus.Fields{
            "task_id": task.ID,
            "attempt": attempt + 1,
            "error":   err.Error(),
        }).Warn("AIæœåŠ¡è°ƒç”¨å¤±è´¥ï¼Œå‡†å¤‡é‡è¯•")
    }
    
    return fmt.Errorf("é‡è¯•æ¬¡æ•°å·²ç”¨å®Œï¼Œæœ€åé”™è¯¯: %w", lastErr)
}
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### ç»“æ„åŒ–æ—¥å¿—è®°å½•
```go
func (s *VolcengineService) logAIRequest(task *Task, duration time.Duration, err error) {
    fields := logrus.Fields{
        "task_id":     task.ID,
        "model_name":  task.ModelName,
        "provider":    "volcengine",
        "duration_ms": duration.Milliseconds(),
    }
    
    if err != nil {
        fields["error"] = err.Error()
        s.logger.WithFields(fields).Error("AIæœåŠ¡è°ƒç”¨å¤±è´¥")
    } else {
        s.logger.WithFields(fields).Info("AIæœåŠ¡è°ƒç”¨æˆåŠŸ")
    }
}
```

### æ€§èƒ½ç›‘æ§
```go
func (s *VolcengineService) GenerateImage(ctx context.Context, task *Task) error {
    start := time.Now()
    defer func() {
        duration := time.Since(start)
        s.logAIRequest(task, duration, nil)
    }()
    
    // AIæœåŠ¡è°ƒç”¨é€»è¾‘...
}
```

## ğŸ”’ å®‰å…¨æœ€ä½³å®è·µ

### APIå¯†é’¥ç®¡ç†
```go
// âœ… ä»ç¯å¢ƒå˜é‡è¯»å–APIå¯†é’¥
func NewVolcengineService(config *AIConfig) *VolcengineService {
    if config.ARKAPIKey == "" {
        panic("ARK_API_KEY is required")
    }
    
    return &VolcengineService{
        arkClient: ark.NewClient(config.ARKAPIKey),
        config:    config,
    }
}

// âŒ é¿å…ç¡¬ç¼–ç APIå¯†é’¥
const ARK_API_KEY = "your-api-key-here" // å±é™©ï¼
```

### è¾“å…¥å†…å®¹è¿‡æ»¤
```go
func (s *VolcengineService) validatePrompt(prompt string) error {
    // æ£€æŸ¥æç¤ºè¯é•¿åº¦
    if len(prompt) > 1000 {
        return errors.New("æç¤ºè¯é•¿åº¦ä¸èƒ½è¶…è¿‡1000å­—ç¬¦")
    }
    
    // æ£€æŸ¥æ•æ„Ÿå†…å®¹ (å¯é›†æˆå†…å®¹å®¡æ ¸æœåŠ¡)
    if containsSensitiveContent(prompt) {
        return errors.New("æç¤ºè¯åŒ…å«æ•æ„Ÿå†…å®¹")
    }
    
    return nil
}
```

## ğŸ¨ å“åº”æ ¼å¼æ ‡å‡†åŒ–

### ç»Ÿä¸€å“åº”ç»“æ„
```go
type AIResponse struct {
    TaskID    string    `json:"task_id"`
    Status    string    `json:"status"` // "pending", "processing", "completed", "failed"
    Result    *AIResult `json:"result,omitempty"`
    Error     string    `json:"error,omitempty"`
    CreatedAt time.Time `json:"created_at"`
    UpdatedAt time.Time `json:"updated_at"`
}

type AIResult struct {
    Type string      `json:"type"` // "image", "video"
    Data interface{} `json:"data"`
}

type ImageResult struct {
    URL    string `json:"url,omitempty"`
    Base64 string `json:"base64,omitempty"`
    Width  int    `json:"width"`
    Height int    `json:"height"`
}
```
