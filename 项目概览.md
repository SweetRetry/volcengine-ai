# 即梦AI服务项目概览

## 项目完整结构

```
jimeng-go-server/
├── cmd/
│   └── server/
│       └── main.go                 # 应用程序入口点
├── internal/
│   ├── config/
│   │   ├── config.go              # 配置管理
│   │   └── config_test.go         # 配置测试
│   ├── database/
│   │   ├── interface.go           # 数据库接口定义
│   │   └── mongodb.go             # MongoDB实现
│   ├── handler/
│   │   ├── ai_handler.go          # AI服务HTTP处理器
│   │   ├── user_handler.go        # 用户管理HTTP处理器
│   │   └── task_handler.go        # 任务管理HTTP处理器
│   ├── middleware/
│   │   ├── cors.go               # CORS跨域中间件
│   │   ├── logger.go             # 日志记录中间件
│   │   └── rate_limiter.go       # 请求限流中间件
│   ├── queue/
│   │   └── redis.go              # Redis队列任务系统
│   ├── router/
│   │   └── router.go             # 路由配置
│   └── service/
│       ├── ai_service.go         # AI服务业务逻辑
│       ├── user_service.go       # 用户服务业务逻辑
│       └── task_service.go       # 任务服务业务逻辑
├── scripts/
│   └── test_api.sh               # API测试脚本
├── config.env                    # 环境变量配置示例
├── docker-compose.yml            # Docker编排配置
├── Dockerfile                    # Docker镜像构建文件
├── go.mod                        # Go模块依赖
├── Makefile                      # 构建和开发命令
├── README.md                     # 项目文档
└── 项目概览.md                   # 本文件

```

## 核心功能模块

### 1. 配置管理 (config/)
- **config.go**: 统一的配置管理，支持环境变量
- **config_test.go**: 配置模块的单元测试

### 2. 数据库层 (database/)
- **interface.go**: 数据库操作接口，支持扩展
- **mongodb.go**: MongoDB实现，使用官方驱动

### 3. HTTP处理器 (handler/)
- **ai_handler.go**: AI相关API处理器
  - 创建异步AI任务
  - 获取任务状态
- **user_handler.go**: 用户管理API处理器
  - CRUD用户操作
- **task_handler.go**: 任务管理API处理器
  - 任务状态查询
  - 任务取消和重试

### 4. 中间件 (middleware/)
- **cors.go**: 跨域资源共享处理
- **logger.go**: 结构化日志记录和错误恢复
- **rate_limiter.go**: 内存限流器

### 5. 队列系统 (queue/)
- **redis.go**: 基于Redis的分布式任务队列
  - 支持优先级队列
  - 支持延迟任务
  - 支持任务重试
  - 支持任务监控

### 6. 路由配置 (router/)
- **router.go**: 统一的路由配置管理

### 7. 业务逻辑层 (service/)
- **ai_service.go**: AI服务调用逻辑
  - 即梦API集成
  - 文本生成、图像生成、翻译
  - 成本计算
- **user_service.go**: 用户管理业务逻辑
- **task_service.go**: 任务管理业务逻辑

## 支持的AI任务类型

### 文本生成 (text_generation)
- 支持多种模型：GPT-3.5, GPT-4, Claude等
- 支持流式和非流式响应
- 支持对话格式

### 图像生成 (image_generation)
- 支持DALL-E、Midjourney、Stable Diffusion等
- 可配置图像尺寸和质量

### 翻译 (translation)
- 基于大语言模型的智能翻译
- 支持多种语言对

## 技术栈

### 后端框架
- **Go 1.21+**: 编程语言
- **Gin**: HTTP Web框架
- **MongoDB Driver**: MongoDB官方驱动

### 数据存储
- **MongoDB**: 文档数据库
- **Redis**: 缓存和队列

### 队列系统
- **Asynq**: 分布式任务队列

### 日志和监控
- **Logrus**: 结构化日志
- **自定义中间件**: 请求监控

### 开发工具
- **Docker**: 容器化部署
- **Docker Compose**: 本地开发环境
- **Make**: 构建自动化
- **测试脚本**: API功能测试

## 部署方式

### 本地开发
```bash
# 安装依赖
make install

# 启动开发环境
make dev

# 或直接运行
make run
```

### Docker部署
```bash
# 构建镜像
make docker-build

# 启动完整环境
docker-compose up -d
```

### 生产部署
```bash
# 构建生产版本
make build-linux

# 部署脚本
make deploy
```

## API文档

### 基础路径
- 健康检查: `GET /health`
- API版本: `/api/v1/`

### 主要端点
- 用户管理: `/api/v1/users/`
- AI任务: `/api/v1/ai/tasks/`
- 任务管理: `/api/v1/tasks/`
- 队列监控: `/api/v1/queue/stats`

## 环境变量配置

### 必要配置
- `JIMENG_API_KEY`: 即梦API密钥
- `MONGO_URL`: MongoDB连接URL
- `REDIS_URL`: Redis连接URL

### 可选配置
- `PORT`: 服务端口 (默认8080)
- `ENVIRONMENT`: 运行环境 (development/production)
- `LOG_LEVEL`: 日志级别 (debug/info/warn/error)

## 测试

### 单元测试
```bash
make test
```

### API测试
```bash
./scripts/test_api.sh
```

### 测试覆盖率
```bash
make test-coverage
```

## 扩展性设计

### 添加新的AI服务提供商
1. 在 `ai_service.go` 中添加新的API调用方法
2. 更新配置结构添加新的配置项
3. 在处理器中添加路由支持

### 添加新的数据库
1. 实现 `database/interface.go` 中定义的接口
2. 在 `main.go` 中添加初始化逻辑
3. 更新配置支持新的数据库类型

### 添加新的队列后端
1. 实现队列接口（参考Redis实现）
2. 在配置中添加新的队列配置
3. 更新服务初始化逻辑

## 最佳实践

### 代码组织
- 采用分层架构：Handler -> Service -> Database
- 接口驱动设计，便于测试和扩展
- 统一的错误处理和日志记录

### 性能优化
- 连接池管理
- 请求限流
- 异步任务处理
- 数据库索引优化

### 安全性
- CORS配置
- 请求验证
- 错误信息脱敏
- 环境变量敏感信息保护

这个项目提供了一个完整的、生产就绪的AI服务基础架构，使用MongoDB作为主要数据存储，可以根据具体需求进行扩展和定制。 