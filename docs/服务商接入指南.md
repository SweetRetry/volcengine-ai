# ğŸš€ æ–°æœåŠ¡å•†æ¥å…¥æŒ‡å—

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•åœ¨å½“å‰çš„Provider-Serviceåˆ†å±‚æ¶æ„åŸºç¡€ä¸Šæ¥å…¥æ–°çš„AIæœåŠ¡å•†ã€‚

## ğŸ—ï¸ æ¶æ„æ¦‚è¿°

### åˆ†å±‚èŒè´£

```
Core Layer     - æ¥å£å®šä¹‰ + ä»»åŠ¡é˜Ÿåˆ— + æœåŠ¡æ³¨å†Œ
Provider Layer - ä»»åŠ¡åˆ†å‘è·¯ç”±ï¼ˆæ ¹æ®modelå‚æ•°é€‰æ‹©Serviceæ–¹æ³•ï¼‰
Service Layer  - å…·ä½“APIè°ƒç”¨å®ç°
```

### æ¥å…¥åŸç†

```
æ–°Providerå®ç°AITaskDispatcheræ¥å£ â†’ æ³¨å†Œåˆ°ServiceRegistry â†’ TaskQueueè°ƒç”¨
```

## ğŸ”§ æ¥å…¥æ­¥éª¤

### 1. å®ç°Serviceå±‚

åˆ›å»º `internal/service/your_service.go`ï¼š

```go
type YourService struct {
    apiKey      string
    taskService *TaskService
}

func (s *YourService) GenerateTextByModel(ctx context.Context, taskID string, input map[string]interface{}) error {
    // 1. æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºprocessing
    // 2. è°ƒç”¨ç¬¬ä¸‰æ–¹API
    // 3. æ›´æ–°ä»»åŠ¡ç»“æœæˆ–é”™è¯¯
}

func (s *YourService) GenerateImageByModel(ctx context.Context, taskID string, input map[string]interface{}) error {
    // åŒä¸Š
}
```

### 2. å®ç°Providerå±‚

åˆ›å»º `internal/provider/your_provider.go`ï¼š

```go
type YourProvider struct {
    yourService *service.YourService
    taskService *service.TaskService
}

func (p *YourProvider) GetProviderName() string {
    return "your-provider-name"
}

func (p *YourProvider) DispatchImageTask(ctx context.Context, taskID string, model string, input map[string]interface{}) error {
    switch model {
    case "model-a":
        return p.yourService.GenerateImageByModelA(ctx, taskID, input)
    case "model-b":
        return p.yourService.GenerateImageByModelB(ctx, taskID, input)
    default:
        return fmt.Errorf("ä¸æ”¯æŒçš„æ¨¡å‹: %s", model)
    }
}

// å®ç°DispatchTextTaskå’ŒDispatchVideoTask
```

### 3. æ·»åŠ é…ç½®

åœ¨ `config/config.go` ä¸­æ·»åŠ é…ç½®å­—æ®µï¼š

```go
type AIConfig struct {
    // ç°æœ‰é…ç½®...
    YourAPIKey string // æ–°æœåŠ¡å•†é…ç½®
}
```

åœ¨ `config/constants.go` ä¸­æ·»åŠ æ¨¡å‹å¸¸é‡ï¼š

```go
const (
    YourTextModel  = "your-text-model"
    YourImageModel = "your-image-model"
)
```

### 4. æ³¨å†Œåˆ°ç³»ç»Ÿ

åœ¨ `cmd/worker/main.go` ä¸­æ³¨å†Œï¼š

```go
// åˆ›å»ºæœåŠ¡
yourService := service.NewYourService(cfg.AI.YourAPIKey, taskService)

// åˆ›å»ºProvider
yourProvider := provider.NewYourProvider(yourService, taskService)

// æ³¨å†Œåˆ°ç³»ç»Ÿ
serviceRegistry.RegisterDispatcher(yourProvider)
```

### 5. ç¯å¢ƒå˜é‡

åœ¨ `.env` æ–‡ä»¶ä¸­æ·»åŠ ï¼š

```bash
YOUR_API_KEY=your_api_key_here
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### APIæµ‹è¯•

```bash
curl -X POST http://localhost:8080/api/v1/ai/text/task \
  -H "Content-Type: application/json" \
  -d '{
    "prompt": "æµ‹è¯•æç¤ºè¯",
    "user_id": "test-user",
    "provider": "your-provider-name",
    "model": "your-text-model"
  }'
```

### éªŒè¯æ­¥éª¤

1. å¯åŠ¨Workerå’ŒAPIæœåŠ¡å™¨
2. æ£€æŸ¥æ—¥å¿—ç¡®è®¤æœåŠ¡å•†å·²æ³¨å†Œ
3. å‘é€æµ‹è¯•è¯·æ±‚éªŒè¯åŠŸèƒ½
4. æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€ç¡®è®¤ç»“æœ

## ğŸ“š å…³é”®è¦ç‚¹

### é”™è¯¯å¤„ç†æ¨¡å¼

```go
// Serviceå±‚ç»Ÿä¸€é”™è¯¯å¤„ç†
if err := s.taskService.UpdateTaskStatus(ctx, taskID, config.TaskStatusProcessing); err != nil {
    return err
}

// APIè°ƒç”¨å¤±è´¥æ—¶
if err != nil {
    s.taskService.UpdateTaskError(ctx, taskID, fmt.Sprintf("APIè°ƒç”¨å¤±è´¥: %v", err))
    return err
}

// æˆåŠŸæ—¶æ›´æ–°ç»“æœ
s.taskService.UpdateTaskTextResult(ctx, taskID, result)
```

### é…ç½®éªŒè¯

```go
func NewYourService(apiKey string, taskService *TaskService) *YourService {
    if apiKey == "" {
        logrus.Fatal("APIå¯†é’¥ä¸èƒ½ä¸ºç©º")
    }
    return &YourService{apiKey: apiKey, taskService: taskService}
}
```

### æ—¥å¿—è®°å½•

```go
logrus.WithFields(logrus.Fields{
    "task_id": taskID,
    "provider": "your-provider",
    "model": model,
}).Info("å¼€å§‹å¤„ç†ä»»åŠ¡")
```

## â“ å¸¸è§é—®é¢˜

**Q: å¦‚ä½•æ”¯æŒæ–°çš„ä»»åŠ¡ç±»å‹ï¼Ÿ**
A: åœ¨AITaskDispatcheræ¥å£ä¸­æ·»åŠ æ–°æ–¹æ³•ï¼Œæ‰€æœ‰Provideréƒ½éœ€è¦å®ç°ã€‚

**Q: å¦‚ä½•å¤„ç†ä¸åŒçš„è®¤è¯æ–¹å¼ï¼Ÿ**
A: åœ¨Serviceå±‚å°è£…è®¤è¯é€»è¾‘ï¼ŒProviderå±‚ä¸å…³å¿ƒè®¤è¯ç»†èŠ‚ã€‚

**Q: å¦‚ä½•åŠ¨æ€ç®¡ç†æœåŠ¡å•†ï¼Ÿ**
A: ä½¿ç”¨ServiceRegistryçš„RegisterDispatcher/UnregisterDispatcheræ–¹æ³•ã€‚

## ğŸ¯ æ€»ç»“

æ¥å…¥æ–°æœåŠ¡å•†åªéœ€è¦ï¼š
1. **ä¸¤ä¸ªæ–‡ä»¶** - Serviceå®ç° + Provideråˆ†å‘
2. **ä¸€å¤„æ³¨å†Œ** - åœ¨worker main.goä¸­æ³¨å†Œ
3. **é…ç½®ç®¡ç†** - æ·»åŠ å¿…è¦çš„é…ç½®é¡¹

è¿™ç§æ¶æ„ç¡®ä¿äº†ï¼š
- **èŒè´£åˆ†ç¦»** - Provideråˆ†å‘ï¼ŒServiceå®ç°
- **æ¥å£ä¸€è‡´** - æ‰€æœ‰Providerå®ç°ç›¸åŒæ¥å£
- **æ˜“äºæ‰©å±•** - æ–°å¢æœåŠ¡å•†ä¸å½±å“ç°æœ‰åŠŸèƒ½ 